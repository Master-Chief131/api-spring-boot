<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/logos/logo_icono.svg" type="image/svg+xml">
    <title>Catálogo de Cuentas Contables</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 0.5rem;
        }
        .card-header {
            background-color: #495057;
            color: white;
            font-weight: 600;
        }
        .search-container {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .table-responsive {
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .badge-activo {
            background-color: #28a745;
        }
        .badge-inactivo {
            background-color: #dc3545;
        }
        .badge-debito {
            background-color: #007bff;
        }
        .badge-credito {
            background-color: #ffc107;
            color: #212529;
        }
        .cuenta-codigo {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #495057;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .nivel-indicator {
            display: inline-block;
            width: 20px;
            text-align: center;
            font-weight: bold;
            border-radius: 3px;
            color: white;
            font-size: 0.8rem;
        }
        .nivel-1 { background-color: #dc3545; }
        .nivel-2 { background-color: #fd7e14; }
        .nivel-3 { background-color: #ffc107; color: #212529; }
        .nivel-4 { background-color: #28a745; }
        .nivel-5 { background-color: #20c997; }
        .pagination-sm .page-link {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .card-footer {
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        #infoPaginacion {
            color: #6c757d;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>
                        Catálogo de Cuentas Operativas
                    </h1>
                    <p class="mb-0 mt-2 opacity-75">Sistema Contable - Cuentas Activas que Permiten Movimiento</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-light" onclick="exportarExcel()">
                            <i class="fas fa-file-excel me-1"></i> Excel
                        </button>
                        <button type="button" class="btn btn-outline-light" onclick="exportarPDF()">
                            <i class="fas fa-file-pdf me-1"></i> PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Search and Filters Section -->
        <div class="search-container">
            <form id="filtrosForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="noCia" class="form-label">
                            <i class="fas fa-building me-1"></i>
                            Compañía
                        </label>
                        <select class="form-select" id="noCia" name="noCia">
                            <option value="">Todas las compañías</option>
                            <option value="1" selected>Compañía 1</option>
                            <option value="2">Compañía 2</option>
                            <option value="3">Compañía 3</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="modo" class="form-label">
                            <i class="fas fa-filter me-1"></i>
                            Modo de Consulta
                        </label>
                        <select class="form-select" id="modo" name="modo">
                            <option value="operativo" selected>Solo Operativas (Activas + Movimiento)</option>
                            <option value="completo">Catálogo Completo (Administrativo)</option>
                        </select>
                    </div>
                    <div class="col-md-3" id="filtroActivo" style="display: none;">
                        <label for="activo" class="form-label">
                            <i class="fas fa-toggle-on me-1"></i>
                            Estado
                        </label>
                        <select class="form-select" id="activo" name="activo">
                            <option value="">Todas</option>
                            <option value="S">Solo Activas</option>
                            <option value="N">Solo Inactivas</option>
                        </select>
                    </div>
                    <div class="col-md-3" id="filtroMovimiento" style="display: none;">
                        <label for="indMov" class="form-label">
                            <i class="fas fa-exchange-alt me-1"></i>
                            Permite Movimiento
                        </label>
                        <select class="form-select" id="indMov" name="indMov">
                            <option value="">Todas</option>
                            <option value="S">Solo con Movimiento</option>
                            <option value="N">Solo sin Movimiento</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="descripcion" class="form-label">
                            <i class="fas fa-search me-1"></i>
                            Buscar
                        </label>
                        <input type="text" class="form-control" id="descripcion" name="descripcion" 
                               placeholder="Descripción o código...">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary me-2" onclick="paginaActual = 0; buscarCuentas(0)">
                            <i class="fas fa-search me-1"></i>
                            Buscar Cuentas
                        </button>
                        <button type="button" class="btn btn-success me-2" onclick="obtenerPlanCompleto()">
                            <i class="fas fa-list me-1"></i>
                            Plan Completo
                        </button>
                        <button type="button" class="btn btn-info me-2" onclick="obtenerEstadisticas()">
                            <i class="fas fa-chart-bar me-1"></i>
                            Estadísticas
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="limpiarFiltros()">
                            <i class="fas fa-broom me-1"></i>
                            Limpiar
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Consultando catálogo de cuentas...</p>
        </div>

        <!-- Statistics Section -->
        <div id="estadisticasSection" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-2"></i>
                    Estadísticas del Catálogo
                </div>
                <div class="card-body">
                    <div class="row" id="estadisticasContent">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-list me-2"></i>
                    Resultados del Catálogo de Cuentas
                </span>
                <span class="badge bg-secondary" id="totalCuentas">0 cuentas</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Nivel</th>
                                <th>Código</th>
                                <th>Descripción</th>
                                <th>Tipo</th>
                                <th>Movimiento</th>
                                <th>Detalle de tercero</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCuentas">
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-search fa-2x mb-2"></i>
                                    <br>
                                    Utilice los filtros para buscar cuentas
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Paginación -->
            <div class="card-footer" id="paginacionSection" style="display: none;">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <label for="tamañoPagina" class="form-label me-2 mb-0">Mostrar:</label>
                            <select class="form-select form-select-sm me-2" id="tamañoPagina" style="width: auto;" onchange="cambiarTamañoPagina()">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="text-muted">por página</span>
                        </div>
                        <small class="text-muted" id="infoPaginacion">Mostrando 0 - 0 de 0 resultados</small>
                    </div>
                    <div class="col-md-6">
                        <nav aria-label="Paginación de cuentas">
                            <ul class="pagination pagination-sm justify-content-end mb-0" id="controlesPaginacion">
                                <!-- Se genera dinámicamente -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Response JSON Section -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-code me-2"></i>
                Respuesta JSON de la API
                <button class="btn btn-sm btn-outline-light float-end" onclick="toggleJsonResponse()">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div class="card-body" id="jsonResponseSection" style="display: none;">
                <pre id="jsonResponse" style="background-color: #f8f9fa; padding: 1rem; border-radius: 0.25rem; max-height: 400px; overflow-y: auto;"></pre>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de cuenta -->
    <div class="modal fade" id="detallesCuentaModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>
                        Detalles de la Cuenta
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detallesCuentaContent">
                    <!-- Se llena dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // URL base de la API
        const API_BASE_URL = '/api/cuentas';
        
        // Variables globales
        let ultimaRespuesta = null;
        let paginaActual = 0; // Spring Boot usa páginas basadas en 0
        let tamañoPaginaActual = 25;
        let totalElementos = 0;
        let totalPaginas = 0;
        let ultimosFiltros = null;
        
        // Función para mostrar loading
        function mostrarLoading(mostrar = true) {
            const loading = document.getElementById('loadingIndicator');
            loading.style.display = mostrar ? 'block' : 'none';
        }
        
        // Función para buscar cuentas con filtros
        async function buscarCuentas(pagina = 0) {
            try {
                mostrarLoading(true);
                
                const formData = new FormData(document.getElementById('filtrosForm'));
                const params = new URLSearchParams();
                
                // Determinar el endpoint según el modo
                const modo = formData.get('modo') || 'operativo';
                let endpoint = `${API_BASE_URL}/dto`; // Por defecto, modo operativo
                
                if (modo === 'completo') {
                    endpoint = `${API_BASE_URL}/completo`;
                }
                
                // Agregar parámetros de paginación
                params.append('page', pagina.toString());
                params.append('size', tamañoPaginaActual.toString());
                params.append('sort', 'cuenta,asc'); // Ordenar por código de cuenta
                
                // Agregar parámetros según el modo
                for (const [key, value] of formData.entries()) {
                    if (key === 'modo') continue; // No enviar el modo como parámetro
                    
                    if (value.trim() !== '') {
                        // En modo operativo, ignorar filtros de activo e indMov (están hardcodeados)
                        if (modo === 'operativo' && (key === 'activo' || key === 'indMov')) {
                            continue;
                        }
                        params.append(key, value);
                    }
                }
                
                const url = `${endpoint}?${params.toString()}`;
                console.log('Consultando URL:', url);
                console.log('Modo seleccionado:', modo);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const respuestaPaginada = await response.json();
                ultimaRespuesta = respuestaPaginada;
                
                // Actualizar variables de paginación
                paginaActual = pagina;
                ultimosFiltros = Object.fromEntries(formData.entries());
                
                // Procesar respuesta según el tipo
                if (modo === 'operativo') {
                    // Para DTOs, la respuesta es un array simple sin paginación del servidor
                    // Simular paginación del lado cliente
                    const inicio = pagina * tamañoPaginaActual;
                    const fin = inicio + tamañoPaginaActual;
                    const cuentasPaginadas = respuestaPaginada.slice(inicio, fin);
                    
                    totalElementos = respuestaPaginada.length;
                    totalPaginas = Math.ceil(totalElementos / tamañoPaginaActual);
                    
                    mostrarCuentasEnTabla(cuentasPaginadas);
                    actualizarPaginacion(inicio, fin, totalElementos);
                } else {
                    // Para el modo completo, usar paginación del servidor
                    if (respuestaPaginada.content) {
                        // Respuesta paginada del servidor
                        totalElementos = respuestaPaginada.totalElements;
                        totalPaginas = respuestaPaginada.totalPages;
                        
                        const cuentasDTO = respuestaPaginada.content.map(cuenta => convertirADTO(cuenta));
                        mostrarCuentasEnTabla(cuentasDTO);
                        
                        const inicio = respuestaPaginada.number * respuestaPaginada.size;
                        const fin = Math.min(inicio + respuestaPaginada.size, totalElementos);
                        actualizarPaginacion(inicio, fin, totalElementos);
                    } else {
                        // Respuesta simple sin paginación
                        const cuentasArray = Array.isArray(respuestaPaginada) ? respuestaPaginada : [respuestaPaginada];
                        const cuentasDTO = cuentasArray.map(cuenta => convertirADTO(cuenta));
                        mostrarCuentasEnTabla(cuentasDTO);
                        
                        totalElementos = cuentasArray.length;
                        totalPaginas = 1;
                        actualizarPaginacion(0, totalElementos, totalElementos);
                    }
                }
                
                mostrarRespuestaJSON(respuestaPaginada);
                actualizarContadorCuentas(totalElementos);
                
                // Actualizar título según el modo
                actualizarTituloSegunModo(modo, totalElementos);
                
            } catch (error) {
                console.error('Error al buscar cuentas:', error);
                mostrarError('Error al consultar las cuentas: ' + error.message);
                ocultarPaginacion();
            } finally {
                mostrarLoading(false);
            }
        }
        
        // Función para obtener el plan completo
        async function obtenerPlanCompleto() {
            try {
                mostrarLoading(true);
                
                const noCia = document.getElementById('noCia').value || '1';
                const url = `${API_BASE_URL}/plan-cuentas?noCia=${noCia}`;
                
                const response = await fetch(url);
                const cuentas = await response.json();
                ultimaRespuesta = cuentas;
                
                // Para el plan completo, simular paginación del lado cliente
                paginaActual = 0;
                totalElementos = cuentas.length;
                totalPaginas = Math.ceil(totalElementos / tamañoPaginaActual);
                
                const inicio = 0;
                const fin = Math.min(tamañoPaginaActual, totalElementos);
                const cuentasPaginadas = cuentas.slice(inicio, fin);
                
                // Convertir a DTOs del lado cliente
                const cuentasDTO = cuentasPaginadas.map(cuenta => convertirADTO(cuenta));
                
                mostrarCuentasEnTabla(cuentasDTO);
                mostrarRespuestaJSON(cuentas);
                actualizarContadorCuentas(totalElementos);
                actualizarPaginacion(inicio, fin, totalElementos);
                
                // Actualizar título
                const tituloCard = document.querySelector('.card-header span');
                tituloCard.innerHTML = '<i class="fas fa-list me-2"></i>Plan de Cuentas Completo';
                
                // Guardar filtros para paginación
                ultimosFiltros = { planCompleto: true, noCia: noCia };
                
            } catch (error) {
                console.error('Error al obtener plan completo:', error);
                mostrarError('Error al obtener el plan de cuentas: ' + error.message);
                ocultarPaginacion();
            } finally {
                mostrarLoading(false);
            }
        }
        
        // Función para obtener estadísticas
        async function obtenerEstadisticas() {
            try {
                mostrarLoading(true);
                
                const noCia = document.getElementById('noCia').value || '1';
                const url = `${API_BASE_URL}/estadisticas?noCia=${noCia}`;
                
                const response = await fetch(url);
                const estadisticas = await response.json();
                
                mostrarEstadisticas(estadisticas);
                mostrarRespuestaJSON(estadisticas);
                
            } catch (error) {
                console.error('Error al obtener estadísticas:', error);
                mostrarError('Error al obtener estadísticas: ' + error.message);
            } finally {
                mostrarLoading(false);
            }
        }
        
        // Función para mostrar cuentas en la tabla
        function mostrarCuentasEnTabla(cuentas) {
            const tbody = document.getElementById('tablaCuentas');
            
            if (!cuentas || cuentas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <br>
                            No se encontraron cuentas con los criterios especificados
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = cuentas.map(cuenta => `
                <tr>
                    <td>
                        ${cuenta.nivel ? `<span class="nivel-indicator nivel-${cuenta.nivel}">${cuenta.nivel}</span>` : '-'}
                    </td>
                    <td>
                        <span class="cuenta-codigo">${cuenta.cuenta || '-'}</span>
                        ${cuenta.padre ? `<br><small class="text-muted">Padre: ${cuenta.padre}</small>` : ''}
                    </td>
                    <td>
                        <strong>${cuenta.descripcion || '-'}</strong>
                        ${cuenta.descripcionLarga && cuenta.descripcionLarga !== cuenta.descripcion ? 
                            `<br><small class="text-muted">${cuenta.descripcionLarga}</small>` : ''}
                    </td>
                    <td>
                        <span class="badge bg-info">${cuenta.tipo || '-'}</span>
                    </td>
                    <td>
                        <span class="badge ${cuenta.indMov === 'S' ? 'bg-success' : 'bg-warning text-dark'}">
                            ${cuenta.tipoMovimiento || '-'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${cuenta.indTercero && cuenta.indTercero !== '' ? 'bg-primary' : 'bg-light text-dark'}">
                            ${cuenta.indTercero && cuenta.indTercero !== '' ? cuenta.indTercero : 'N'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${cuenta.activo === 'S' ? 'badge-activo' : 'badge-inactivo'}">
                            ${cuenta.estadoDescripcion || '-'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="verDetalles('${cuenta.noCia}', '${cuenta.cuenta}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Función para mostrar estadísticas
        function mostrarEstadisticas(estadisticas) {
            const section = document.getElementById('estadisticasSection');
            const content = document.getElementById('estadisticasContent');
            
            content.innerHTML = `
                <div class="col-md-3 text-center">
                    <div class="card border-primary">
                        <div class="card-body">
                            <h3 class="text-primary">${estadisticas.total_cuentas || 0}</h3>
                            <p class="mb-0">Total Cuentas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card border-success">
                        <div class="card-body">
                            <h3 class="text-success">${estadisticas.cuentas_activas || 0}</h3>
                            <p class="mb-0">Cuentas Activas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card border-info">
                        <div class="card-body">
                            <h3 class="text-info">${estadisticas.cuentas_debito || 0}</h3>
                            <p class="mb-0">Cuentas Débito</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card border-warning">
                        <div class="card-body">
                            <h3 class="text-warning">${estadisticas.cuentas_credito || 0}</h3>
                            <p class="mb-0">Cuentas Crédito</p>
                        </div>
                    </div>
                </div>
            `;
            
            section.style.display = 'block';
        }
        
        // Función para mostrar respuesta JSON
        function mostrarRespuestaJSON(data) {
            const jsonElement = document.getElementById('jsonResponse');
            jsonElement.textContent = JSON.stringify(data, null, 2);
        }
        
        // Función para alternar visibilidad del JSON
        function toggleJsonResponse() {
            const section = document.getElementById('jsonResponseSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }
        
        // Función para actualizar contador
        function actualizarContadorCuentas(cantidad) {
            document.getElementById('totalCuentas').textContent = `${cantidad} cuenta${cantidad !== 1 ? 's' : ''}`;
        }
        
        // Función para limpiar filtros
        function limpiarFiltros() {
            document.getElementById('filtrosForm').reset();
            document.getElementById('noCia').value = '1';
            document.getElementById('modo').value = 'operativo';
            document.getElementById('tamañoPagina').value = '25';
            
            // Resetear variables de paginación
            paginaActual = 0;
            tamañoPaginaActual = 25;
            totalElementos = 0;
            totalPaginas = 0;
            ultimosFiltros = null;
            
            // Ocultar filtros administrativos
            document.getElementById('filtroActivo').style.display = 'none';
            document.getElementById('filtroMovimiento').style.display = 'none';
            
            document.getElementById('tablaCuentas').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted py-4">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <br>
                        Utilice los filtros para buscar cuentas operativas
                    </td>
                </tr>
            `;
            document.getElementById('estadisticasSection').style.display = 'none';
            actualizarContadorCuentas(0);
            
            // Actualizar título
            const tituloCard = document.querySelector('.card-header span');
            tituloCard.innerHTML = '<i class="fas fa-list me-2"></i>Cuentas Operativas (Activas + Movimiento)';
            
            // Ocultar paginación
            ocultarPaginacion();
        }
        
        // Funciones de paginación
        function actualizarPaginacion(inicio, fin, total) {
            if (total === 0) {
                ocultarPaginacion();
                return;
            }
            
            // Mostrar información de paginación
            document.getElementById('infoPaginacion').textContent = 
                `Mostrando ${inicio + 1} - ${fin} de ${total.toLocaleString()} resultados`;
            
            // Generar controles de paginación
            generarControlesPaginacion();
            
            // Mostrar sección de paginación
            document.getElementById('paginacionSection').style.display = 'block';
        }
        
        function generarControlesPaginacion() {
            const controles = document.getElementById('controlesPaginacion');
            const maxBotones = 5; // Máximo número de botones de página a mostrar
            
            let html = '';
            
            // Botón anterior
            html += `
                <li class="page-item ${paginaActual === 0 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="cambiarPagina(${paginaActual - 1})" aria-label="Anterior">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `;
            
            // Calcular rango de páginas a mostrar
            let inicioRango = Math.max(0, paginaActual - Math.floor(maxBotones / 2));
            let finRango = Math.min(totalPaginas - 1, inicioRango + maxBotones - 1);
            
            // Ajustar inicio si estamos cerca del final
            if (finRango - inicioRango < maxBotones - 1) {
                inicioRango = Math.max(0, finRango - maxBotones + 1);
            }
            
            // Primera página si no está en el rango
            if (inicioRango > 0) {
                html += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="cambiarPagina(0)">1</a>
                    </li>
                `;
                if (inicioRango > 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            // Páginas en el rango
            for (let i = inicioRango; i <= finRango; i++) {
                html += `
                    <li class="page-item ${i === paginaActual ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="cambiarPagina(${i})">${i + 1}</a>
                    </li>
                `;
            }
            
            // Última página si no está en el rango
            if (finRango < totalPaginas - 1) {
                if (finRango < totalPaginas - 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="cambiarPagina(${totalPaginas - 1})">${totalPaginas}</a>
                    </li>
                `;
            }
            
            // Botón siguiente
            html += `
                <li class="page-item ${paginaActual >= totalPaginas - 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="cambiarPagina(${paginaActual + 1})" aria-label="Siguiente">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `;
            
            controles.innerHTML = html;
        }
        
        function cambiarPagina(nuevaPagina) {
            if (nuevaPagina < 0 || nuevaPagina >= totalPaginas || nuevaPagina === paginaActual) {
                return;
            }
            
            // Verificar si estamos en modo plan completo
            if (ultimosFiltros && ultimosFiltros.planCompleto) {
                cargarPaginaPlanCompleto(nuevaPagina);
            } else {
                buscarCuentas(nuevaPagina);
            }
        }
        
        function cargarPaginaPlanCompleto(pagina) {
            if (!ultimaRespuesta || !Array.isArray(ultimaRespuesta)) {
                return;
            }
            
            paginaActual = pagina;
            const inicio = pagina * tamañoPaginaActual;
            const fin = Math.min(inicio + tamañoPaginaActual, ultimaRespuesta.length);
            const cuentasPaginadas = ultimaRespuesta.slice(inicio, fin);
            
            // Convertir a DTOs del lado cliente
            const cuentasDTO = cuentasPaginadas.map(cuenta => convertirADTO(cuenta));
            
            mostrarCuentasEnTabla(cuentasDTO);
            actualizarPaginacion(inicio, fin, ultimaRespuesta.length);
        }
        
        function cambiarTamañoPagina() {
            tamañoPaginaActual = parseInt(document.getElementById('tamañoPagina').value);
            paginaActual = 0; // Resetear a la primera página
            
            // Verificar si estamos en modo plan completo
            if (ultimosFiltros && ultimosFiltros.planCompleto) {
                totalPaginas = Math.ceil(ultimaRespuesta.length / tamañoPaginaActual);
                cargarPaginaPlanCompleto(0);
            } else {
                buscarCuentas(0);
            }
        }
        
        function ocultarPaginacion() {
            document.getElementById('paginacionSection').style.display = 'none';
        }
        
        // Función para ver detalles de cuenta
        async function verDetalles(noCia, cuenta) {
            try {
                const url = `${API_BASE_URL}/${noCia}/${encodeURIComponent(cuenta)}`;
                const response = await fetch(url);
                const cuentaDetalle = await response.json();
                
                const modal = new bootstrap.Modal(document.getElementById('detallesCuentaModal'));
                const content = document.getElementById('detallesCuentaContent');
                
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Información Básica</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Código:</strong></td><td>${cuentaDetalle.cuenta}</td></tr>
                                <tr><td><strong>Descripción:</strong></td><td>${cuentaDetalle.descripcion}</td></tr>
                                <tr><td><strong>Compañía:</strong></td><td>${cuentaDetalle.noCia}</td></tr>
                                <tr><td><strong>Tipo:</strong></td><td>${cuentaDetalle.tipo}</td></tr>
                                <tr><td><strong>Nivel:</strong></td><td>${cuentaDetalle.nivel}</td></tr>
                                <tr><td><strong>Padre:</strong></td><td>${cuentaDetalle.padre || 'N/A'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Configuración</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Permite Mov.:</strong></td><td>${cuentaDetalle.indMov}</td></tr>
                                <tr><td><strong>Activo:</strong></td><td>${cuentaDetalle.activo}</td></tr>
                                <tr><td><strong>Clase:</strong></td><td>${cuentaDetalle.clase || 'N'}</td></tr>
                                <tr><td><strong>Ajustable:</strong></td><td>${cuentaDetalle.ajustable || 'N'}</td></tr>
                                <tr><td><strong>Acepta CC:</strong></td><td>${cuentaDetalle.aceptaCc || 'N'}</td></tr>
                                <tr><td><strong>Ind. Tercero:</strong></td><td>${cuentaDetalle.indTercero || 'N'}</td></tr>
                            </table>
                        </div>
                    </div>
                    ${cuentaDetalle.descripLarga ? `
                        <div class="mt-3">
                            <h6>Descripción Extendida</h6>
                            <p class="bg-light p-2 rounded">${cuentaDetalle.descripLarga}</p>
                        </div>
                    ` : ''}
                `;
                
                modal.show();
                
            } catch (error) {
                console.error('Error al obtener detalles:', error);
                mostrarError('Error al obtener detalles de la cuenta');
            }
        }
        
        // Función para mostrar errores
        function mostrarError(mensaje) {
            const tbody = document.getElementById('tablaCuentas');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <br>
                        ${mensaje}
                    </td>
                </tr>
            `;
        }
        
        // Función para convertir entidad a DTO (lado cliente)
        function convertirADTO(cuenta) {
            return {
                noCia: cuenta.noCia,
                cuenta: cuenta.cuenta,
                descripcion: cuenta.descripcion,
                descripcionLarga: cuenta.descripLarga || cuenta.descrip1,
                tipo: cuenta.tipo,
                clase: cuenta.clase,
                indMov: cuenta.indMov,
                nivel: cuenta.nivel,
                padre: cuenta.padre,
                activo: cuenta.activo,
                indTercero: cuenta.indTercero,
                tipoMovimiento: cuenta.indMov === 'S' ? 'Permite Movimiento' : 'No Permite Movimiento',
                estadoDescripcion: cuenta.activo === 'S' ? 'Activa' : 'Inactiva'
            };
        }
        
        // Funciones de exportación (placeholder)
        function exportarExcel() {
            if (!ultimaRespuesta) {
                alert('No hay datos para exportar. Realice una búsqueda primero.');
                return;
            }
            // Implementar exportación a Excel
            console.log('Exportando a Excel...', ultimaRespuesta);
            alert('Funcionalidad de exportación a Excel en desarrollo');
        }
        
        function exportarPDF() {
            if (!ultimaRespuesta) {
                alert('No hay datos para exportar. Realice una búsqueda primero.');
                return;
            }
            // Implementar exportación a PDF
            console.log('Exportando a PDF...', ultimaRespuesta);
            alert('Funcionalidad de exportación a PDF en desarrollo');
        }
        
        // Función para actualizar título según el modo
        function actualizarTituloSegunModo(modo, total) {
            const tituloCard = document.querySelector('.card-header span');
            if (modo === 'operativo') {
                tituloCard.innerHTML = '<i class="fas fa-list me-2"></i>Cuentas Operativas (Activas + Movimiento)';
            } else {
                tituloCard.innerHTML = '<i class="fas fa-list me-2"></i>Catálogo Completo (Modo Administrativo)';
            }
        }
        
        // Función para manejar cambio de modo
        function manejarCambioModo() {
            const modo = document.getElementById('modo').value;
            const filtroActivo = document.getElementById('filtroActivo');
            const filtroMovimiento = document.getElementById('filtroMovimiento');
            
            if (modo === 'completo') {
                // Mostrar filtros adicionales en modo administrativo
                filtroActivo.style.display = 'block';
                filtroMovimiento.style.display = 'block';
            } else {
                // Ocultar filtros en modo operativo
                filtroActivo.style.display = 'none';
                filtroMovimiento.style.display = 'none';
                // Limpiar valores
                document.getElementById('activo').value = '';
                document.getElementById('indMov').value = '';
            }
        }
        
        // Eventos
        document.addEventListener('DOMContentLoaded', function() {
            // Event listener para cambio de modo
            document.getElementById('modo').addEventListener('change', manejarCambioModo);
            
            // Inicializar modo
            manejarCambioModo();
            
            // Inicializar variables de paginación
            paginaActual = 0;
            tamañoPaginaActual = 25;
            totalElementos = 0;
            totalPaginas = 0;
            ultimosFiltros = null;
            
            // Buscar cuentas operativas por defecto (primera página)
            buscarCuentas(0);
            
            // Enter en el campo de búsqueda
            document.getElementById('descripcion').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    paginaActual = 0; // Resetear a primera página al buscar
                    buscarCuentas(0);
                }
            });
        });
    </script>
</body>
</html>
